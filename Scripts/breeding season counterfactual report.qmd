---
title: "House Finch Simulation Round 2"
author: "July Pilowsky"
format: html
editor: visual
---

```{r setup, include = F}
library(poems)
library(qs)
library(tidyverse)
library(furrr)
library(sf)
library(rasterVis)
library(cowplot)
library(paletteer)
plan(multisession, workers = 2)
results_dir <- here::here("Data/Output/breeding season counterfactual")
data.dir <- "~/Documents/Very_Large_Data"
region <- here::here("Data/Input/finch_region.qs") |> qread()
proj_crs <- "+proj=aea +lon_0=-94.5 +lat_1=21.5 +lat_2=47.5 +lat_0=34.5 +datum=WGS84 +units=m +no_defs"
wgs84 <- "GEOGCRS[\"WGS 84\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ID[\"EPSG\",6326]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433],\n        ID[\"EPSG\",8901]],\n    CS[ellipsoidal,2],\n        AXIS[\"longitude\",east,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]],\n        AXIS[\"latitude\",north,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]]]"
```

# What I did in Round 2

Round 2 simulations went from 1994 to 2016. I filtered down the first 10,000 simulations to the ones that ended with house finches in Washington, DC in 1993. 3,211 remained. These simulations I continued from 1994 to 2016, introducing infected birds in DC at the first time step.

# Validation

I fully intend to implement a more formal validation process in the future. However, for now, I have two quick-and-dirty validation metrics. The first: does the disease persist until 2016? The second: does the house finch population persist until 2016?

```{r, echo = F, message = F}
survival <- list.files(results_dir, pattern = "qs", full.names = TRUE) |>
  gtools::mixedsort() %>%
  future_map_lgl(function(file) {
    mat <- qread(file)
    mat$all$abundance[23, 2] > 0
  })
prevalences <- list.files(results_dir, pattern = "qs", full.names = TRUE) |>
  gtools::mixedsort() %>%
  future_map(function(file) {
    mat <- qread(file)
    prevalence <- (mat$all$abundance_segments$stage_1_compartment_2 +
                   mat$all$abundance_segments$stage_2_compartment_2 +
                   mat$all$abundance_segments$stage_1_compartment_4 +
                   mat$all$abundance_segments$stage_2_compartment_4) /
                  (mat$all$abundance_segments$stage_1_compartment_1 +
                   mat$all$abundance_segments$stage_2_compartment_1 +
                   mat$all$abundance_segments$stage_1_compartment_3 +
                   mat$all$abundance_segments$stage_2_compartment_3)
    return(prevalence[23, 2])
  })
print(paste0("Out of ", length(survival), " simulations, ", sum(survival), " survived to 2016."))
ggplot(data = NULL, aes(x = prevalences |> keep(\(x) is.finite(x)) |> 
                          flatten_int())) +
  geom_histogram() + 
  xlab("Prevalence in 2016") + ylab("Number of Simulations")
```

# Time Series

Let's look at some time series of disease compartments from a random selection of simulations.

```{r viz}
time_series_list <- list.files(results_dir, pattern = "qs", full.names = TRUE) |>
  gtools::mixedsort() %>%
  future_map(function(file) {
    mat <- qread(file)
    infected <- mat$all$abundance_segments$stage_1_compartment_2 +
                mat$all$abundance_segments$stage_2_compartment_2
    recovered <- mat$all$abundance_segments$stage_1_compartment_3 +
                 mat$all$abundance_segments$stage_2_compartment_3
    time_series <- data.frame(
      time = 1994:1996 |> rep(each = 2),
      season = 1:2 |> rep(3),
      infected = infected[1:3, ] |> t() |> as.vector(),
      recovered = recovered[1:3, ] |> t() |> as.vector()
    )
    return(time_series)
  })
of_interest <- time_series_list |> map(\(x) pull(x, recovered)) |> 
  map_int(sum) |> map_lgl(\(x) x > 0)
time_series_list |> keep(of_interest) |> sample(5) |> 
  map(\(x) ggplot(x, aes(x = time, y = infected, group = season)) +
       geom_line(aes(color = factor(season))) +
       geom_line(aes(y = recovered), color = "black") +
       scale_color_paletteer_d("dichromat::Categorical_12") +
       theme_minimal() +
       labs(title = "Infected and Recovered Birds Over Time",
            x = "Year", y = "Number of Birds") +
       theme(legend.position = "none"))
```

We can see that all the outbreaks fizzle out almost immediately. This is likely due to starting the simulations in the breeding season when the population is less susceptible to the disease.
