---
title: "House Finch Simulation Round 1"
author: "July Pilowsky"
format: html
editor: visual
---

```{r setup, include = F}
library(poems)
library(qs)
library(tidyverse)
library(furrr)
library(sf)
library(rasterVis)
library(cowplot)
library(paletteer)
plan(sequential)
results_dir <- here::here("Data/Output/Round 1")
data.dir <- "~/Documents/Very_Large_Data"
region <- here::here("Data/Input/finch_region.qs") |> qread()
proj_crs <- "+proj=aea +lon_0=-94.5 +lat_1=21.5 +lat_2=47.5 +lat_0=34.5 +datum=WGS84 +units=m +no_defs"
wgs84 <- "GEOGCRS[\"WGS 84\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ID[\"EPSG\",6326]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433],\n        ID[\"EPSG\",8901]],\n    CS[ellipsoidal,2],\n        AXIS[\"longitude\",east,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]],\n        AXIS[\"latitude\",north,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]]]"
```

# What I did in Round 1

Round 1 simulations went from 1940 to 1993, the year before the first MG outbreak in house finches. The starting state was the native range in the West and one population in Jones Beach, where the only known release of house finches in the East occurred. The expectation was that this would jump off into a full invasion of the East until both the invasive and native ranges met in the middle in the Great Plains. I tried a range of model settings over 10,000 simulations.

# Validation

I fully intend to implement a more formal validation process in the future. However, for now, I have two quick-and-dirty validation metrics. The first: in the final timestep of the simulation, are there house finches in Washington, DC (the location of the initial MG outbreak)? The second: is the range size of the house finch close to what we know the range size ought to be in 1993, measured in number of grid cells in the study region?

```{r, echo = F, message = F}
hofi_sample <- vroom::vroom(file.path(data.dir, "hofi_gbif_qc.tsv")) %>% 
  filter(year < 2017) |> 
  select(decimallongitude, decimallatitude) %>% 
  sf_project(from = wgs84, to = proj_crs) %>%
  raster::rasterize(region$region_raster)
dc <- list.files(results_dir, pattern = "qs", full.names = TRUE) |>
  gtools::mixedsort() %>%
  future_map_lgl(function(file) {
    mat <- qread(file)
    mat$abundance[3531, 59, 1] > 0
  })
ranges <- list.files(results_dir, pattern = "qs", full.names = TRUE) |>
  gtools::mixedsort() %>%
  future_map_int(function(file) {
    mat <- qread(file)
    sum(mat$abundance[, 59, 1] > 0)
  })
print(paste0("Out of 10,000 simulations, ", sum(dc), " had birds present in DC."))
ggplot(data = NULL, aes(x = ranges)) + geom_histogram() + 
  geom_vline(xintercept = sum(raster::values(hofi_sample > 0), na.rm = T),
             linetype = "dashed")
```

None of the simulations meet the minimum requirement of having birds in DC in 1993. None of the simulations even get close to the target range size of 4,511 cells.

# The Top Performers

Let's look at the simulation that hit the largest range size, #5564.

```{r viz}
qread(file.path(results_dir, "sample_5564_results.qs"))$abundance[ , 59, 1] |> 
  region$raster_from_values() |> 
  gplot() + geom_tile(aes(fill = value)) + theme_map() +
  scale_fill_paletteer_c("grDevices::Rocket", transform = "log1p",
                         breaks = c(0, 10, 100, 1000, 10000, 100000),
                         name = "Abundance") +
  ggtitle("Summer 1993")
qread(file.path(results_dir, "sample_5564_results.qs"))$abundance[ , 59, 2] |> 
  region$raster_from_values() |> 
  gplot() + geom_tile(aes(fill = value)) + theme_map() +
  scale_fill_paletteer_c("grDevices::Rocket", transform = "log1p",
                         breaks = c(0, 10, 100, 1000, 10000, 100000),
                         name = "Abundance") +
  ggtitle("Winter 1993/94")
```

We can see here that there is a dynamic of winter transients (dispersal occurs at the beginning of winter) that do not survive the winter, so the range essentially never expands.
